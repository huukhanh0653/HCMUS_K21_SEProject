
# Stage 1: Build the JAR
FROM maven:3.8.6-eclipse-temurin-17 AS builder
WORKDIR /app

COPY pom.xml .

RUN mvn dependency:go-offline

COPY src ./src
RUN mvn clean package -DskipTests

# Stage 2: Run the JAR
FROM eclipse-temurin:17-jre-jammy
WORKDIR /app
COPY --from=builder /app/target/*.jar app.jar

# Khai báo các ARG để nhận giá trị từ secrets
ARG SPRING_DATA_MONGODB_URI
ARG SPRING_GRAPHQL_SCHEMA_LOCATIONS
ARG SPRING_GRAPHQL_GRAPHIQL_ENABLED
ARG SPRING_GRAPHQL_GRAPHIQL_PATH
ARG SPRING_JACKSON_SERIALIZATION_WRITE_DATES_AS_TIMESTAMPS
ARG SERVER_PORT
ARG SPRING_KAFKA_BOOTSTRAP_SERVERS
ARG SPRING_KAFKA_PRODUCER_KEY_SERIALIZER
ARG SPRING_KAFKA_PRODUCER_VALUE_SERIALIZER
ARG SPRING_KAFKA_PROPERTIES_SPRING_JSON_ADD_TYPE_HEADERS
ARG SPRING_DATA_REDIS_HOST
ARG SPRING_DATA_REDIS_PORT
ARG SPRING_DATA_REDIS_PASSWORD

# Gán các ARG thành ENV để Spring Boot nhận được
ENV SPRING_APPLICATION_NAME=Demo-Message-DDD \
    SPRING_DATA_MONGODB_URI=$SPRING_DATA_MONGODB_URI \
    SPRING_GRAPHQL_SCHEMA_LOCATIONS=$SPRING_GRAPHQL_SCHEMA_LOCATIONS \
    SPRING_GRAPHQL_GRAPHIQL_ENABLED=$SPRING_GRAPHQL_GRAPHIQL_ENABLED \
    SPRING_GRAPHQL_GRAPHIQL_PATH=$SPRING_GRAPHQL_GRAPHIQL_PATH \
    SPRING_JACKSON_SERIALIZATION_WRITE_DATES_AS_TIMESTAMPS=$SPRING_JACKSON_SERIALIZATION_WRITE_DATES_AS_TIMESTAMPS \
    SERVER_PORT=$SERVER_PORT \
    SPRING_KAFKA_BOOTSTRAP_SERVERS=$SPRING_KAFKA_BOOTSTRAP_SERVERS \
    SPRING_KAFKA_PRODUCER_KEY_SERIALIZER=$SPRING_KAFKA_PRODUCER_KEY_SERIALIZER \
    SPRING_KAFKA_PRODUCER_VALUE_SERIALIZER=$SPRING_KAFKA_PRODUCER_VALUE_SERIALIZER \
    SPRING_KAFKA_PROPERTIES_SPRING_JSON_ADD_TYPE_HEADERS=$SPRING_KAFKA_PROPERTIES_SPRING_JSON_ADD_TYPE_HEADERS \
    SPRING_DATA_REDIS_HOST=$SPRING_DATA_REDIS_HOST \
    SPRING_DATA_REDIS_PORT=$SPRING_DATA_REDIS_PORT \
    SPRING_DATA_REDIS_PASSWORD=$SPRING_DATA_REDIS_PASSWORD

# Port và user
EXPOSE 8082
RUN useradd -m myuser && chown -R myuser:myuser /app
USER myuser

# Run app
ENTRYPOINT ["java", "-jar", "app.jar"]
